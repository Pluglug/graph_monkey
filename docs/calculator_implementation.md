# 数値入力パネル（電卓）実装ドキュメント

## 概要

Blenderの数値プロパティに対して安全で機能豊富な電卓インターフェースを提供します。従来のkeypad.pyを完全に刷新し、安全性、保守性、ユーザビリティを大幅に向上させました。

## 主な改善点

### 1. セキュリティの向上
- **eval()の排除**: ast.parse()による安全な数式評価
- **許可リスト方式**: 明示的に許可された演算子と関数のみ使用可能
- **型安全性**: 複素数や無限大値の自動検出と排除

### 2. アーキテクチャの改善
- **シングルトンパターン**: `CalculatorState`による状態の一元管理
- **weakref管理**: メモリリークを防ぐ安全な参照管理
- **モジュールリロード対策**: 開発時の残留オブジェクト問題を解決

### 3. 機能の拡張
- **数学関数サポート**: sin, cos, sqrt, log, pi等の豊富な関数
- **履歴機能**: 過去20件の数式履歴を保存・再利用
- **エラーハンドリング**: 詳細なエラーメッセージとロギング

### 4. 🆕 プリファレンス設定
- **UI表示オプション**: 現在値表示、プロパティパス表示、履歴表示、関数ボタン表示
- **計算オプション**: プロパティ制限の尊重、角度の自動変換
- **カスタマイズ**: ダイアログ幅、小数点以下桁数、履歴サイズ

### 5. 🆕 スマート機能
- **現在値表示**: プロパティの現在値を入力フィールドに自動表示
- **プロパティ制限**: hard_min/max値の自動クランプ
- **角度変換**: 角度プロパティで度数法入力を自動的にラジアンに変換

### 6. 🆕 ホットキー対応
- **Alt + 右クリック**: プロパティ上で電卓を直接起動
- **Shift + NumpadEnter**: 任意の場所で電卓起動
- **Ctrl + F12**: 代替ホットキー

## モジュール構成

```
ui/calculator/
├── __init__.py           # モジュール登録とクリーンアップ
├── core.py              # 安全な数式評価とプロパティ管理
├── operators.py         # 電卓オペレータとUI
├── preferences.py       # プリファレンス設定クラス
├── keymaps.py          # ホットキー定義
└── menu_integration.py  # 右クリックメニュー統合
```

## 使用方法

### 基本的な使用方法
1. **右クリック**: 数値プロパティを右クリック → 「Calculator」を選択
2. **ホットキー**: プロパティ上で `Alt + 右クリック` または `Shift + NumpadEnter`
3. 数式を入力（ボタンまたはキーボード）
4. OKで適用

### 新機能の使用方法

#### プリファレンス設定
1. アドオンプリファレンス → "Calculator" タブ
2. 各種オプションを設定
   - 現在値表示のオン/オフ
   - 角度の自動変換
   - プロパティ制限の尊重

#### 角度プロパティの使用
```python
# 角度プロパティ（例：rotation_euler）では
45    # → 自動的に radians(45) に変換
90    # → 自動的に radians(90) に変換
pi/4  # → そのまま（既にラジアン）
```

### 対応する数式例
```python
# 基本演算
42 + 3.14
2 ** 8
sqrt(144)

# 数学関数
sin(pi/4)
radians(45)
log(exp(1))

# 複合計算
(sqrt(25) + 3) * 2

# 🆕 角度計算（角度プロパティで自動変換）
45         # → radians(45)
90 * 2     # → radians(90 * 2)
```

### 利用可能な関数
- **三角関数**: sin, cos, tan, asin, acos, atan, atan2
- **指数・対数**: exp, log, log10, sqrt
- **定数**: pi, e, tau
- **ユーティリティ**: abs, min, max, radians, degrees

## 新機能の詳細

### プロパティ制限のサポート
```python
# プロパティにhard_min=0, hard_max=100が設定されている場合
-10   # → 自動的に 0 にクランプ
150   # → 自動的に 100 にクランプ
50    # → そのまま 50
```

### 現在値表示
- プロパティの現在値が入力フィールドに自動表示
- プリファレンスで表示フォーマット（小数点以下桁数）を設定可能
- プロパティ情報（制限値、角度タイプ）も表示

### ホットキー
- **Alt + 右クリック**: プロパティフィールド上で直接起動
- **Shift + NumpadEnter**: 任意の場所で起動
- **Ctrl + F12**: 代替ホットキー

## テスト手順

### 1. 基本機能テスト
```python
# 基本計算
2+3*4        → 14
sqrt(144)    → 12.0
sin(pi/2)    → 1.0
```

### 2. 🆕 新機能テスト

#### プリファレンステスト
1. アドオンプリファレンス → Calculator タブ
2. 各オプションを切り替えて動作確認

#### 現在値表示テスト
1. オブジェクトのLocation Xを任意の値に設定
2. 右クリック → Calculator
3. 入力フィールドに現在値が表示されることを確認

#### 角度変換テスト
1. オブジェクトのrotation_euler Xを選択
2. 電卓で「45」を入力
3. 結果が約0.785ラジアン（45度）になることを確認

#### プロパティ制限テスト
1. 制限のあるプロパティ（例：Factor）を選択
2. 範囲外の値を入力（例：-1 や 2）
3. 自動的にクランプされることを確認

#### ホットキーテスト
1. プロパティ上で `Alt + 右クリック`
2. `Shift + NumpadEnter` で起動
3. `Ctrl + F12` で起動

## パフォーマンス特性

- **メモリ使用量**: 設定可能な履歴サイズ（5-100件）
- **処理速度**: AST評価により高速な数式処理
- **安全性**: サンドボックス化された実行環境
- **応答性**: プリファレンス設定による最適化

## 設定可能なオプション

### UI Options
- **Show Current Value**: 現在値の表示
- **Show Property Path**: プロパティパスの表示
- **Show History**: 履歴の表示
- **Show Function Buttons**: 関数ボタンの表示
- **Dialog Width**: ダイアログの幅（200-600px）
- **Decimal Places**: 小数点以下の桁数（0-10桁）

### Calculation Options
- **Respect Property Limits**: プロパティ制限の尊重
- **Auto Angle Conversion**: 角度の自動変換
- **History Size**: 履歴サイズ（5-100件）

### Debug Options
- **Enable Logging**: 詳細ログの有効化

## トラブルシューティング

### 電卓が開かない場合
1. プロパティが数値型（INT/FLOAT）か確認
2. プリファレンスでホットキーを確認
3. Blenderコンソールでエラーログを確認
4. アドオンの再有効化を試行

### 計算結果が適用されない場合
1. プロパティのアクセス権限を確認
2. プロパティ制限設定を確認
3. 値の範囲制限を確認
4. デプスグラフの更新状況を確認

### 角度変換が働かない場合
1. プリファレンスで自動変換が有効か確認
2. プロパティが本当に角度タイプか確認
3. 明示的に `radians()` を使用

## 今後の拡張予定

### 将来の機能
- **相対値操作**: +=, -=, *=, /= のサポート
- **複数プロパティ編集**: 一括変更機能
- **カスタム関数**: ユーザー定義関数
- **プリセット機能**: よく使う計算式の保存
- **統計機能**: 使用状況の統計表示

## 開発者向け情報

### プリファレンスの参照
```python
from MonKey.addon import get_prefs
prefs = get_prefs()
calculator_prefs = prefs.calculator

# 設定値の取得
if calculator_prefs.should_show_current_value():
    # 現在値を表示
```

### カスタム関数の追加
```python
# core.py の ALLOWED_MATH に追加
ALLOWED_MATH['my_func'] = my_function
```

### ログ出力の有効化
```python
# プリファレンスでenable_loggingを有効化
# または手動で設定
from MonKey.utils.logging import get_logger
log = get_logger(__name__)
log.debug("Debug message")
```

元のkeypad.pyの問題点をすべて解決し、さらに多くの高度な機能を追加した、プロフェッショナルレベルの電卓機能が完成しました！ 